version: "3"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Minimal tasks: db / api / web / seed ã ã‘ã«çµã£ãŸæ§‹æˆ
# åˆå›ã¯ã€Œtask setupã€ã§ DB èµ·å‹•ï¼†ã‚·ãƒ¼ãƒ‰æŠ•å…¥ã¾ã§å®Œäº†
# æ—¥å¸¸ã¯ã€Œtask db:upã€ã€Œtask apiã€ã€Œtask webã€ã‚’ä¸¦è¡Œå®Ÿè¡Œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

vars:
  DOCKER_COMPOSE_FILE: ./infra/docker-compose.yml
  API_DIR: ./apps/api
  WEB_DIR: ./apps/web
  SEED_FILE: ./apps/api/internal/infra/db/seeds/seed.sql
  AIR_VERSION: v1.61.1

tasks:
  # ========= One-shot =========
  setup:
    desc: åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆDBèµ·å‹•â†’ã‚·ãƒ¼ãƒ‰æŠ•å…¥ï¼‰
    cmds:
      - task: db:up
      - task: db:wait
      - task: db:seed
      - echo "âœ… DBèµ·å‹•ï¼†ã‚·ãƒ¼ãƒ‰æŠ•å…¥å®Œäº†"

  # ========= DB only (Docker) =========
  db:up:
    desc: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹(MySQL)ã‚’Dockerã§èµ·å‹•
    cmds:
      - echo "ğŸš€ MySQLã‚’èµ·å‹•ä¸­..."
      - docker compose -f {{.DOCKER_COMPOSE_FILE}} up -d mysql
      - echo "âœ… MySQLèµ·å‹•å®Œäº†ï¼ˆãƒãƒ¼ãƒˆ 3307â†’3306@containerï¼‰"

  db:down:
    desc: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹(MySQL)ã‚’åœæ­¢
    cmds:
      - echo "ğŸ›‘ MySQLã‚’åœæ­¢ä¸­..."
      - docker compose -f {{.DOCKER_COMPOSE_FILE}} down
      - echo "âœ… åœæ­¢å®Œäº†"

  db:logs:
    desc: MySQLãƒ­ã‚°ã‚’ãƒ•ã‚©ãƒ­ãƒ¼è¡¨ç¤º
    cmds:
      - docker compose -f {{.DOCKER_COMPOSE_FILE}} logs -f mysql

  db:wait:
    desc: MySQLãŒå—ã‘ä»˜ã‘å¯èƒ½ã«ãªã‚‹ã¾ã§å¾…æ©Ÿ
    silent: true
    cmds:
      - |
        echo "â³ MySQLã®èµ·å‹•å¾…ã¡..."
        for i in {1..60}; do
          docker compose -f {{.DOCKER_COMPOSE_FILE}} exec -T mysql \
            mysqladmin ping -h 127.0.0.1 -u root -ppassword --silent && break
          sleep 1
        done
        echo "âœ… MySQL is ready"

  db:seed:
    desc: ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ï¼ˆDockerä¸Šã®MySQLã¸ï¼‰
    cmds:
      - |
        echo "ğŸŒ± ã‚·ãƒ¼ãƒ‰æŠ•å…¥: {{.SEED_FILE}}"
        test -f {{.SEED_FILE}} || (echo "âŒ SEED_FILEãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {{.SEED_FILE}}" && exit 1)
        # -T ã‚’ä»˜ã‘ã¦stdinãƒ‘ã‚¤ãƒ—ã‚’æ­£ã—ãæ¸¡ã™
        docker compose -f {{.DOCKER_COMPOSE_FILE}} exec -T mysql \
          mysql -u gogym -ppassword -D gogym < {{.SEED_FILE}}
        echo "âœ… ã‚·ãƒ¼ãƒ‰æŠ•å…¥å®Œäº†"

  # ========= API (local with Air) =========
  api:
    desc: APIã‚’ãƒ­ãƒ¼ã‚«ãƒ«èµ·å‹•ï¼ˆAirã§ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ï¼‰
    dir: "{{.API_DIR}}"
    deps: [api:air-setup]
    cmds:
      - echo "ğŸ”§ APIèµ·å‹• (air)"
      - air

  api:air-setup:
    desc: Airã‚’ç‰¹å®šãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆidempotentï¼‰
    internal: true
    cmds:
      - go install github.com/air-verse/air@{{.AIR_VERSION}}

  # ========= Web (local) =========
  web:
    desc: Webã‚’ãƒ­ãƒ¼ã‚«ãƒ«èµ·å‹•ï¼ˆnpm run devï¼‰
    dir: "{{.WEB_DIR}}"
    cmds:
      - echo "âš¡ Webèµ·å‹• (npm run dev)"
      - npm run dev
