version: "3"

# åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—:
#   task dev              # å®Œå…¨ãªé–‹ç™ºç’°å¢ƒèµ·å‹•ï¼ˆæ¨å¥¨ï¼‰
#
# æ—¥å¸¸é–‹ç™º:
#   task up               # Dockerã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•
#   task down             # å…¨ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢
#   task logs             # å…¨ãƒ­ã‚°è¡¨ç¤º
#   task logs-api         # APIãƒ­ã‚°ã®ã¿
#   task health           # ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ³ç¢ºèª
#
# ã‚³ãƒ¼ãƒ‰å¤‰æ›´æ™‚:
#   task gen              # OpenAPIâ†’Go/TSç”Ÿæˆ
#   task test             # å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
#   task lint             # é™çš„è§£æå®Ÿè¡Œ
#
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹:
#   task migrate          # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
#   task seed             # ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿æŠ•å…¥
#   task migrate-status   # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ³
#
# ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œï¼ˆDockerä¸è¦ï¼‰:
#   task api              # Go APIãƒ­ãƒ¼ã‚«ãƒ«èµ·å‹•
#   task web              # Next.js Webãƒ­ãƒ¼ã‚«ãƒ«èµ·å‹•
#
# ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹:
#   task clean            # å…¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
#   task build            # ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰

vars:
  DOCKER_COMPOSE_FILE: ./infra/docker/docker-compose.yml
  API_DIR: ./apps/api
  WEB_DIR: ./apps/web
  OPENAPI_DIR: ./packages/openapi

tasks:
  setup:
    desc: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆåˆå›å®Ÿè¡Œæ™‚ï¼‰
    deps: [gen, up, migrate, seed]
    cmds:
      - echo "âœ… GoGymé–‹ç™ºç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
      - echo "ğŸŒ Web: http://localhost:3000"
      - echo "ğŸ”§ API: http://localhost:8080"
      - echo "ğŸ’¾ MinIO: http://localhost:9001 (minioadmin/minioadmin123)"

  clean:
    desc: ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ã¨Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    cmds:
      - echo "ğŸ§¹ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’é–‹å§‹..."
      - task: down
      - rm -rf {{.API_DIR}}/internal/gen
      - rm -rf {{.WEB_DIR}}/types/generated
      - rm -rf {{.OPENAPI_DIR}}/generated
      - docker system prune -f
      - echo "âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"

  gen:
    desc: OpenAPIä»•æ§˜ã‹ã‚‰Goãƒ»TypeScriptã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
    deps: [gen-go, gen-ts]
    cmds:
      - echo "âœ… å…¨ã‚³ãƒ¼ãƒ‰ç”Ÿæˆå®Œäº†ï¼"

  gen-go:
    desc: OpenAPIä»•æ§˜ã‹ã‚‰Goã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
    dir: "{{.OPENAPI_DIR}}"
    cmds:
      - echo "ğŸ”§ Goã‚³ãƒ¼ãƒ‰ç”Ÿæˆä¸­..."
      - ./gen-go.sh

  gen-ts:
    desc: OpenAPIä»•æ§˜ã‹ã‚‰TypeScriptã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ç”Ÿæˆ
    dir: "{{.OPENAPI_DIR}}"
    cmds:
      - echo "ğŸ”§ TypeScriptã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”Ÿæˆä¸­..."
      - ./gen-ts.sh

  up:
    desc: å…¨ã‚µãƒ¼ãƒ“ã‚¹ã‚’Dockerã§èµ·å‹•
    cmds:
      - echo "ğŸš€ Dockerã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•ä¸­..."
      - docker-compose -f {{.DOCKER_COMPOSE_FILE}} up -d
      - echo "âœ… ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•å®Œäº†"

  down:
    desc: å…¨ã‚µãƒ¼ãƒ“ã‚¹ã‚’åœæ­¢
    cmds:
      - echo "ğŸ›‘ ã‚µãƒ¼ãƒ“ã‚¹ã‚’åœæ­¢ä¸­..."
      - docker-compose -f {{.DOCKER_COMPOSE_FILE}} down
      - echo "âœ… ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢å®Œäº†"

  logs:
    desc: å…¨ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ­ã‚°ã‚’è¡¨ç¤º
    cmds:
      - docker-compose -f {{.DOCKER_COMPOSE_FILE}} logs -f

  logs-api:
    desc: APIã‚µãƒ¼ãƒãƒ¼ã®ãƒ­ã‚°ã®ã¿è¡¨ç¤º
    cmds:
      - docker-compose -f {{.DOCKER_COMPOSE_FILE}} logs -f api

  logs-web:
    desc: Webã‚µãƒ¼ãƒãƒ¼ã®ãƒ­ã‚°ã®ã¿è¡¨ç¤º
    cmds:
      - docker-compose -f {{.DOCKER_COMPOSE_FILE}} logs -f web

  migrate:
    desc: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
    cmds:
      - echo "ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œä¸­..."
      - docker-compose -f {{.DOCKER_COMPOSE_FILE}} exec api goose -dir /app/infra/migrations mysql "gogym:password@tcp(mysql:3306)/gogym" up
      - echo "âœ… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†"

  migrate-down:
    desc: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
    cmds:
      - echo "âª ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œä¸­..."
      - docker-compose -f {{.DOCKER_COMPOSE_FILE}} exec api goose -dir /app/infra/migrations mysql "gogym:password@tcp(mysql:3306)/gogym" down
      - echo "âœ… ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Œäº†"

  migrate-status:
    desc: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ç¢ºèª
    cmds:
      - docker-compose -f {{.DOCKER_COMPOSE_FILE}} exec api goose -dir /app/infra/migrations mysql "gogym:password@tcp(mysql:3306)/gogym" status

  seed:
    desc: ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æŠ•å…¥
    cmds:
      - echo "ğŸŒ± ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿æŠ•å…¥ä¸­..."
      - docker-compose -f {{.DOCKER_COMPOSE_FILE}} exec mysql mysql -u gogym -ppassword -D gogym < /app/infra/seeds/seed.sql
      - echo "âœ… ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿æŠ•å…¥å®Œäº†"

  dev:
    desc: å®Œå…¨ãªé–‹ç™ºç’°å¢ƒã‚’èµ·å‹•ï¼ˆæ¨å¥¨ï¼‰
    cmds:
      - echo "ğŸš€ GoGymé–‹ç™ºç’°å¢ƒã‚’èµ·å‹•ä¸­..."
      - task: gen
      - task: up
      - task: migrate
      - echo ""
      - echo "ğŸ‰ é–‹ç™ºç’°å¢ƒèµ·å‹•å®Œäº†ï¼"
      - echo "ğŸ“± Web: http://localhost:3000"
      - echo "ğŸ”§ API: http://localhost:8080"
      - echo "ğŸ’¾ MinIO: http://localhost:9001 (minioadmin/minioadmin123)"
      - echo ""
      - echo "ğŸ“‹ ä¾¿åˆ©ãªã‚³ãƒãƒ³ãƒ‰:"
      - echo "  task logs
      - echo "  task logs-api
      - echo "  task logs-web
      - echo "  task down

  api:
    desc: APIã‚µãƒ¼ãƒãƒ¼ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§èµ·å‹•ï¼ˆãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰æœ‰åŠ¹ï¼‰
    dir: "{{.API_DIR}}"
    cmds:
      - echo "ğŸ”§ Go APIã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§èµ·å‹•ä¸­..."
      - go run cmd/api/main.go

  api-build:
    desc: APIãƒã‚¤ãƒŠãƒªã‚’ãƒ“ãƒ«ãƒ‰
    dir: "{{.API_DIR}}"
    cmds:
      - echo "ğŸ”¨ Go APIãƒ“ãƒ«ãƒ‰ä¸­..."
      - go build -o bin/gogym-api cmd/api/main.go
      - echo "âœ… APIãƒ“ãƒ«ãƒ‰å®Œäº†: bin/gogym-api"

  api-test:
    desc: APIãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
    dir: "{{.API_DIR}}"
    cmds:
      - echo "ğŸ§ª Go APIãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
      - go test -v ./...

  api-lint:
    desc: APIã‚³ãƒ¼ãƒ‰ã®é™çš„è§£æ
    dir: "{{.API_DIR}}"
    cmds:
      - echo "ğŸ” Go APIãƒªãƒ³ãƒˆå®Ÿè¡Œä¸­..."
      - golangci-lint run

  web:
    desc: Webã‚µãƒ¼ãƒãƒ¼ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§èµ·å‹•ï¼ˆãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰æœ‰åŠ¹ï¼‰
    dir: "{{.WEB_DIR}}"
    cmds:
      - echo "âš¡ Next.js Webã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§èµ·å‹•ä¸­..."
      - pnpm dev

  web-build:
    desc: Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰
    dir: "{{.WEB_DIR}}"
    cmds:
      - echo "ğŸ”¨ Next.js Webãƒ“ãƒ«ãƒ‰ä¸­..."
      - pnpm build
      - echo "âœ… Webãƒ“ãƒ«ãƒ‰å®Œäº†"

  web-test:
    desc: Webãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
    dir: "{{.WEB_DIR}}"
    cmds:
      - echo "ğŸ§ª Next.js ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
      - pnpm test

  web-lint:
    desc: Webã‚³ãƒ¼ãƒ‰ã®é™çš„è§£æ
    dir: "{{.WEB_DIR}}"
    cmds:
      - echo "ğŸ” TypeScript/React ãƒªãƒ³ãƒˆå®Ÿè¡Œä¸­..."
      - pnpm lint

  test:
    desc: APIãƒ»Webä¸¡æ–¹ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
    deps: [api-test, web-test]
    cmds:
      - echo "âœ… å…¨ãƒ†ã‚¹ãƒˆå®Œäº†ï¼"

  lint:
    desc: APIãƒ»Webä¸¡æ–¹ã®é™çš„è§£æã‚’å®Ÿè¡Œ
    deps: [api-lint, web-lint]
    cmds:
      - echo "âœ… å…¨ãƒªãƒ³ãƒˆå®Œäº†ï¼"

  build:
    desc: APIãƒ»Webä¸¡æ–¹ã‚’ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ç”¨ãƒ“ãƒ«ãƒ‰
    deps: [api-build, web-build]
    cmds:
      - echo "âœ… å…¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰å®Œäº†ï¼"

  health:
    desc: å…¨ã‚µãƒ¼ãƒ“ã‚¹ã®ç¨¼åƒçŠ¶æ³ã‚’ç¢ºèª
    cmds:
      - echo "ğŸ¥ ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ³ç¢ºèªä¸­..."
      - curl -f http://localhost:8080/health || echo "âŒ API: åœæ­¢ä¸­"
      - curl -f http://localhost:3000 || echo "âŒ Web: åœæ­¢ä¸­"
      - docker-compose -f {{.DOCKER_COMPOSE_FILE}} exec mysql mysqladmin ping -h mysql -u gogym -ppassword || echo "âŒ MySQL: åœæ­¢ä¸­"
      - docker-compose -f {{.DOCKER_COMPOSE_FILE}} exec redis redis-cli ping || echo "âŒ Redis: åœæ­¢ä¸­"
      - echo "âœ… ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Œäº†"
