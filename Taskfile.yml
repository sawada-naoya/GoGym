version: "3"

vars:
  DOCKER_COMPOSE_FILE: ./infra/docker-compose.yml
  MIGRATIONS_DIR: ./apps/api/internal/infra/db/migrations
  DB_URL: postgres://gogym:gogym_password@localhost:5433/gogym?sslmode=disable

tasks:
  setup:
    desc: åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆDBèµ·å‹•â†’migrateï¼‰
    cmds:
      - task: db:up
      - task: db:wait
      - task: db:migrate
      - echo "âœ… DBèµ·å‹•"

  # ========= DB only (Docker) =========
  db:up:
    desc: PostgreSQLã‚’Dockerã§èµ·å‹•
    cmds:
      - echo "ğŸš€ PostgreSQLã‚’èµ·å‹•ä¸­..."
      - docker compose -f {{.DOCKER_COMPOSE_FILE}} up -d postgres
      - echo "âœ… PostgreSQLèµ·å‹•å®Œäº†"

  db:down:
    desc: DBã‚’åœæ­¢
    cmds:
      - docker compose -f {{.DOCKER_COMPOSE_FILE}} down

  db:logs:
    desc: PostgreSQLãƒ­ã‚°ã‚’ãƒ•ã‚©ãƒ­ãƒ¼è¡¨ç¤º
    cmds:
      - docker compose -f {{.DOCKER_COMPOSE_FILE}} logs -f postgres

  db:wait:
    desc: PostgreSQLãŒå—ã‘ä»˜ã‘å¯èƒ½ã«ãªã‚‹ã¾ã§å¾…æ©Ÿ
    silent: true
    cmds:
      - |
        echo "â³ PostgreSQLã®èµ·å‹•å¾…ã¡..."
        for i in {1..60}; do
          docker compose -f {{.DOCKER_COMPOSE_FILE}} exec -T postgres \
            pg_isready -U gogym -d gogym >/dev/null 2>&1 && break
          sleep 1
        done
        echo "âœ… PostgreSQL is ready"

  db:migrate:
    desc: golang-migrateã§upã‚’å®Ÿè¡Œ
    cmds:
      - |
        echo "ğŸ§± migrate up..."
        migrate -path "{{.MIGRATIONS_DIR}}" -database "{{.DB_URL}}" up
        echo "âœ… migrate up å®Œäº†"
