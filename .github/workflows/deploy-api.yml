name: Deploy API to Render/Fly.io

on:
  push:
    branches:
      - main
    paths:
      - 'apps/api/**'
      - '.github/workflows/deploy-api.yml'

jobs:
  deploy:
    name: Deploy API
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/api
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.25"
          cache-dependency-path: apps/api/go.sum

      - name: Install wire
        run: go install github.com/google/wire/cmd/wire@latest

      - name: Go mod tidy (check clean)
        run: |
          go mod tidy
          if ! git diff --quiet go.mod go.sum; then
            echo "::error::go.mod / go.sum is not tidy. Run 'go mod tidy' locally and commit the changes."
            git diff
            exit 1
          fi

      - name: Generate wire
        run: cd internal/di && wire

      - name: Build
        run: go build ./...

      - name: Go vet
        run: go vet ./...

      - name: Test before deploy
        run: |
          if find . -name "*_test.go" | grep -q .; then
            go test ./... -race -count=1 -coverprofile=coverage.out
          else
            echo "no tests yet; skipping"
          fi

      # Render.com を使う場合はここにRender CLI設定
      # Fly.io を使う場合は以下のようにflyctl設定

      # - uses: superfly/flyctl-actions/setup-flyctl@master
      # - run: flyctl deploy --remote-only
      #   working-directory: apps/api
      #   env:
      #     FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      # Renderの場合は単にgit pushでトリガーされるので
      # 明示的なデプロイコマンドは不要
      - name: Trigger Render Deploy
        run: echo "Render deploys automatically on git push"
